version: 2

models:
  - name: Question_Performance_Data
    description: "Aggregated KPIs by creation month for Stack Overflow questions."
    meta:
      owner: Christopher Lewis
      domain: stack_overflow
      layer: semantic
      maturity: high

    columns:
      - name: creation_month
        description: "DATE_TRUNC(creation_dt, MONTH)."
        tests: [not_null]

      - name: creation_year
      - name: creation_month_num
      - name: creation_quarter

      - name: sample_question_id
        description: "MIN(question_id) used as a representative FK for sanity."
        tests:
          - relationships:
              to: ref('Facts_Questions')
              field: question_id
              where: "creation_month >= DATE_SUB(CURRENT_DATE(), INTERVAL 24 MONTH)"
              config:
                severity: warn

      - name: distinct_count_of_question_id
        tests:
          - dbt_utils.expression_is_true:
              arguments: { expression: ">= 0" }

      - name: distinct_count_of_asker_user_id
        tests:
          - dbt_utils.expression_is_true:
              arguments: { expression: ">= 0" }

      - name: distinct_count_of_accepted_answer_id
        tests:
          - dbt_utils.expression_is_true:
              arguments: { expression: ">= 0" }

      - name: distinct_count_of_answerer_id
        tests:
          - dbt_utils.expression_is_true:
              arguments: { expression: ">= 0" }

      - name: distinct_count_of_answerer_user_id
        tests:
          - dbt_utils.expression_is_true:
              arguments: { expression: ">= 0" }

      - name: sum_of_answer_count
        tests:
          - dbt_utils.expression_is_true:
              arguments: { expression: ">= 0" }

      - name: sum_of_view_count
        tests:
          - dbt_utils.expression_is_true:
              arguments: { expression: ">= 0" }

      - name: sum_of_favorite_count
        tests:
          - dbt_utils.expression_is_true:
              arguments: { expression: ">= 0" }

      - name: comment_count_summed
        tests:
          - dbt_utils.expression_is_true:
              arguments: { expression: ">= 0" }

      - name: questions_with_answers
        tests:
          - dbt_utils.expression_is_true:
              arguments: { expression: ">= 0" }

      - name: questions_with_accepted
        tests:
          - dbt_utils.expression_is_true:
              arguments: { expression: ">= 0" }

      - name: has_answers_rate
        description: "Share of questions with â‰¥1 answer."
        tests:
          - dbt_utils.expression_is_true:
              arguments: { expression: ">= 0" }
          - dbt_utils.expression_is_true:
              arguments: { expression: "<= 1" }

      - name: accepted_rate
        description: "Share of questions with an accepted answer."
        tests:
          - dbt_utils.expression_is_true:
              arguments: { expression: ">= 0" }
          - dbt_utils.expression_is_true:
              arguments: { expression: "<= 1" }

      - name: tags_array
        description: "Distinct tags across the month."

      - name: tags_csv
        description: "Distinct tags across the month (pipe-delimited)."
